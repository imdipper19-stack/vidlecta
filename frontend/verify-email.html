<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Verify Email — VidLecta</title>
    <meta name="robots" content="noindex, nofollow">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/pages/auth.css">
</head>

<body class="auth-page">
    <div class="auth-container auth-single">
        <div class="auth-form-container">
            <div class="auth-form-wrapper">
                <a href="/" class="navbar-brand auth-logo">
                    <svg width="40" height="40" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="url(#gradient)" />
                        <path d="M12 10L22 16L12 22V10Z" fill="white" />
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop stop-color="#7c3aed" />
                                <stop offset="1" stop-color="#3b82f6" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>VidLecta</span>
                </a>

                <!-- Loading State -->
                <div id="state-loading">
                    <div class="auth-header">
                        <div class="loading-spinner-large"></div>
                        <h1>Подтверждение email...</h1>
                        <p>Пожалуйста, подождите</p>
                    </div>
                </div>

                <!-- Success State -->
                <div id="state-success" class="hidden">
                    <div class="auth-header">
                        <div class="success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <h1>Email подтверждён! ✅</h1>
                        <p>Спасибо! Ваш email успешно подтверждён.</p>
                    </div>

                    <a href="/dashboard.html" class="btn btn-primary btn-lg w-full">
                        Перейти в Dashboard
                    </a>
                </div>

                <!-- Error State -->
                <div id="state-error" class="hidden">
                    <div class="auth-header">
                        <div class="error-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <h1>Ошибка подтверждения</h1>
                        <p id="error-message">Ссылка недействительна или устарела.</p>
                    </div>

                    <button class="btn btn-secondary w-full" onclick="resendEmail()">
                        Отправить письмо повторно
                    </button>

                    <p class="auth-footer-text" style="margin-top: 24px;">
                        <a href="/login.html">Вернуться ко входу</a>
                    </p>
                </div>

                <!-- Already Verified State -->
                <div id="state-already" class="hidden">
                    <div class="auth-header">
                        <div class="success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <h1>Уже подтверждён</h1>
                        <p>Этот email уже был подтверждён ранее.</p>
                    </div>

                    <a href="/login.html" class="btn btn-primary btn-lg w-full">
                        Войти в аккаунт
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // States
        const stateLoading = document.getElementById('state-loading');
        const stateSuccess = document.getElementById('state-success');
        const stateError = document.getElementById('state-error');
        const stateAlready = document.getElementById('state-already');

        function showState(state) {
            stateLoading.classList.add('hidden');
            stateSuccess.classList.add('hidden');
            stateError.classList.add('hidden');
            stateAlready.classList.add('hidden');
            state.classList.remove('hidden');
        }

        async function verifyEmail() {
            if (!token) {
                document.getElementById('error-message').textContent = 'Токен отсутствует в ссылке.';
                showState(stateError);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/verify-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (response.ok) {
                    showState(stateSuccess);
                } else if (response.status === 409) {
                    // Already verified
                    showState(stateAlready);
                } else {
                    document.getElementById('error-message').textContent = data.detail || 'Ссылка недействительна.';
                    showState(stateError);
                }
            } catch (error) {
                document.getElementById('error-message').textContent = 'Ошибка сервера. Попробуйте позже.';
                showState(stateError);
            }
        }

        async function resendEmail() {
            // Get email from localStorage or prompt
            const email = localStorage.getItem('pending_verification_email') ||
                prompt('Введите ваш email:');

            if (!email) return;

            try {
                const response = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (response.ok) {
                    alert('Письмо отправлено! Проверьте почту.');
                } else {
                    alert('Не удалось отправить письмо.');
                }
            } catch (error) {
                alert('Ошибка сервера.');
            }
        }

        // Start verification on page load
        verifyEmail();
    </script>

    <style>
        .auth-single {
            justify-content: center;
        }

        .auth-single .auth-form-container {
            max-width: 450px;
            margin: 0 auto;
        }

        .auth-logo {
            justify-content: center;
            margin-bottom: var(--spacing-8);
        }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-6);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-6);
            color: var(--color-success);
        }

        .error-icon {
            width: 80px;
            height: 80px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-6);
            color: var(--color-error);
        }
    </style>
</body>

</html>